name: Post release to Discord

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag de la release Ã  envoyer (ex: 0.0.9)'
        required: true
        type: string
      ping_role_id:
        description: 'Optionnel : ID du rÃ´le Ã  ping (sans @). Ex: 123456789012345678'
        required: false
        type: string

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Validate webhook secret
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          set -e
          if [ -z "$DISCORD_WEBHOOK_URL" ]; then
            echo "Missing DISCORD_WEBHOOK_URL secret"
            exit 1
          fi

      - name: Resolve release data (published or manual tag)
        id: rel
        env:
          GH_TOKEN: ${{ github.token }}
          INPUT_TAG: ${{ github.event.inputs.tag }}
        run: |
          set -e

          if [ -n "$INPUT_TAG" ]; then
            echo "Manual run: fetching release for tag $INPUT_TAG"
            DATA="$(gh api "repos/${GITHUB_REPOSITORY}/releases/tags/${INPUT_TAG}")"

            TAG="$(echo "$DATA" | jq -r '.tag_name')"
            NAME="$(echo "$DATA" | jq -r '.name // .tag_name')"
            URL="$(echo "$DATA" | jq -r '.html_url')"
            BODY="$(echo "$DATA" | jq -r '.body // ""')"

            echo "tag=$TAG" >> "$GITHUB_OUTPUT"
            echo "name=$NAME" >> "$GITHUB_OUTPUT"
            echo "url=$URL" >> "$GITHUB_OUTPUT"

            # IMPORTANT: multiline output safe
            echo "body<<EOF" >> "$GITHUB_OUTPUT"
            printf "%s\n" "$BODY" >> "$GITHUB_OUTPUT"
            echo "EOF" >> "$GITHUB_OUTPUT"
          else
            echo "tag=${{ github.event.release.tag_name }}" >> "$GITHUB_OUTPUT"
            echo "name=${{ github.event.release.name }}" >> "$GITHUB_OUTPUT"
            echo "url=${{ github.event.release.html_url }}" >> "$GITHUB_OUTPUT"

            echo "body<<EOF" >> "$GITHUB_OUTPUT"
            echo "${{ github.event.release.body }}" >> "$GITHUB_OUTPUT"
            echo "EOF" >> "$GITHUB_OUTPUT"
          fi

      - name: Post to Discord (embed)
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          RELEASE_TAG: ${{ steps.rel.outputs.tag }}
          RELEASE_NAME: ${{ steps.rel.outputs.name }}
          RELEASE_URL: ${{ steps.rel.outputs.url }}
          RELEASE_BODY: ${{ steps.rel.outputs.body }}
          PING_ROLE_ID: ${{ github.event.inputs.ping_role_id }}
        run: |
          set -e

          if [ -z "$DISCORD_WEBHOOK_URL" ]; then
            echo "Missing DISCORD_WEBHOOK_URL secret"
            exit 1
          fi

          NAME="${RELEASE_NAME:-$RELEASE_TAG}"

          # Tronque la description (Discord embed description max 4096, on reste safe)
          DESC="$(printf "%s" "$RELEASE_BODY" | head -c 3500)"
          if [ "$(printf "%s" "$RELEASE_BODY" | wc -c | tr -d ' ')" -gt 3500 ]; then
            DESC="${DESC}â€¦"
          fi

          # Ping optionnel (uniquement en manual run, sinon vide)
          if [ -n "$PING_ROLE_ID" ]; then
            CONTENT="<@&${PING_ROLE_ID}>"
          else
            CONTENT=""
          fi

          # Embed + lien + footer repo
          JSON="$(jq -n \
            --arg content "$CONTENT" \
            --arg title "ðŸ“¦ Release ${NAME} (${RELEASE_TAG})" \
            --arg url "$RELEASE_URL" \
            --arg desc "$DESC" \
            --arg footer "${GITHUB_REPOSITORY}" \
            '{
              content: $content,
              embeds: [
                {
                  title: $title,
                  url: $url,
                  description: $desc,
                  footer: { text: $footer }
                }
              ]
            }'
          )"

          curl -sS -X POST \
            -H "Content-Type: application/json" \
            -d "$JSON" \
            "$DISCORD_WEBHOOK_URL"
