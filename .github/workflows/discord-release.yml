name: Post release to Discord

on:
  release:
    types: [published]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Post to Discord
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          RELEASE_NAME: ${{ github.event.release.name }}
          RELEASE_TAG: ${{ github.event.release.tag_name }}
          RELEASE_URL: ${{ github.event.release.html_url }}
          RELEASE_BODY: ${{ github.event.release.body }}
        run: |
          set -e

          if [ -z "$DISCORD_WEBHOOK_URL" ]; then
            echo "Missing DISCORD_WEBHOOK_URL secret"
            exit 1
          fi

          NAME="${RELEASE_NAME:-$RELEASE_TAG}"

          # Tronque pour Ã©viter les limites Discord
          BODY="$(printf "%s" "$RELEASE_BODY" | head -c 1500)"
          if [ "$(printf "%s" "$RELEASE_BODY" | wc -c | tr -d ' ')" -gt 1500 ]; then
            BODY="${BODY}â€¦"
          fi

          # Build JSON propre (escape via python en one-liner, sans heredoc)
          CONTENT="ðŸ“¦ **Nouvelle release : ${NAME}** (\`${RELEASE_TAG}\`)\n${RELEASE_URL}\n\n${BODY}"
          JSON=$(python -c 'import json,os; print(json.dumps({"content": os.environ["CONTENT"]}))' )

          curl -sS -X POST \
            -H "Content-Type: application/json" \
            -d "$JSON" \
            "$DISCORD_WEBHOOK_URL"
