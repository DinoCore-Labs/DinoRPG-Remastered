generator client {
  provider        = "prisma-client-js"
  output          = "../../prisma"
  previewFeatures = ["nativeDistinct", "relationJoins"]
  binaryTargets   = ["native", "debian-openssl-3.0.x", "debian-openssl-1.1.x"]
}

datasource db {
  provider = "postgresql"
}

model Dinoz {
  id                 Int         @id @default(autoincrement())
  name               String      @db.VarChar(32)
  canRename          Boolean     @default(false)
  raceId             Int
  display            String      @db.VarChar
  level              Int         @default(1)
  life               Int
  maxLife            Int
  experience         Int
  nbrUpFire          Int
  nbrUpWood          Int
  nbrUpWater         Int
  nbrUpLightning     Int
  nbrUpAir           Int
  nextUpElementId    Int
  nextUpAltElementId Int
  placeId            Int
  remaining          Int         @default(3)
  order              Int?
  createdDate        DateTime    @default(now()) @db.Timestamptz(3)
  updatedDate        DateTime    @updatedAt @db.Timestamptz(3)
  seed               String      @db.Uuid
  state              DinozState?
  stateTimer         DateTime?   @db.Timestamptz(3)

  fight            Boolean                 @default(true)
  gather           Boolean                 @default(true)
  leaderId         Int?                    @map("following")
  leader           Dinoz?                  @relation("DinozFollowers", fields: [leaderId], references: [id])
  followers        Dinoz[]                 @relation("DinozFollowers")
  items            DinozItems[]
  skills           DinozSkills[]
  unlockableSkills DinozSkillsUnlockable[]
  status           DinozStatus[]

  userId String @db.Uuid
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([userId])
}

model DinozItems {
  id      Int    @id() @default(autoincrement())
  itemId  Int
  dinozId Int?
  dinoz   Dinoz? @relation(fields: [dinozId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([dinozId])
  @@map("dinoz_item")
}

model DinozSkills {
  id      Int     @id @default(autoincrement())
  skillId Int
  state   Boolean @default(true)
  dinozId Int?
  dinoz   Dinoz?  @relation(fields: [dinozId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([skillId, dinozId])
  @@index([dinozId])
  @@map("dinoz_skill")
}

model DinozSkillsUnlockable {
  id      Int    @id @default(autoincrement())
  skillId Int
  dinozId Int?
  dinoz   Dinoz? @relation(fields: [dinozId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@map("dinoz_skill_unlockable")
}

model DinozStatus {
  id       Int    @id @default(autoincrement())
  statusId Int
  dinozId  Int?
  dinoz    Dinoz? @relation(fields: [dinozId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([statusId, dinozId])
  @@index([dinozId])
  @@map("dinoz_status")
}

model JobDefinition {
  id      String  @id @default(cuid())
  key     String  @unique // ex: "reset-dinoz-shop"
  name    String
  type    JobType
  enabled Boolean @default(true)

  // Scheduling
  timezone    String @default("UTC")
  dailyHour   Int?
  dailyMinute Int?
  intervalMs  Int?

  // State
  status    JobStatus @default(IDLE)
  lastRunAt DateTime? @db.Timestamptz(3)
  nextRunAt DateTime? @db.Timestamptz(3)
  lastError String?

  // Locking (multi-instance safe)
  lockedAt     DateTime? @db.Timestamptz(3)
  lockedBy     String?
  lockTimeoutS Int       @default(300)

  runs JobRun[]

  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @updatedAt @db.Timestamptz(3)

  @@map("job_definition")
}

model JobRun {
  id    String        @id @default(cuid())
  jobId String
  job   JobDefinition @relation(fields: [jobId], references: [id], onDelete: Cascade)

  startedAt   DateTime  @default(now()) @db.Timestamptz(3)
  endedAt     DateTime? @db.Timestamptz(3)
  success     Boolean?
  error       String?
  triggeredBy String?

  @@index([jobId, startedAt])
  @@map("job_run")
}

model Ranking {
  id         Int @id @default(autoincrement())
  dinozCount Int @default(0)
  points     Int @default(0)
  average    Int @default(0)
  completion Int @default(0)
  dojo       Int @default(0)

  userId String @unique @db.Uuid
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model SignupDeviceMonthCounter {
  id          Int      @id @default(autoincrement())
  monthKey    String
  deviceToken String
  count       Int      @default(0)
  expiresAt   DateTime @db.Timestamptz(3)
  createdAt   DateTime @default(now()) @db.Timestamptz(3)
  updatedAt   DateTime @updatedAt @db.Timestamptz(3)

  @@unique([monthKey, deviceToken])
  @@index([monthKey])
  @@index([expiresAt])
}

model SignupIpMonthCounter {
  id        Int      @id @default(autoincrement())
  monthKey  String
  ipToken   String
  count     Int      @default(0)
  expiresAt DateTime @db.Timestamptz(3)
  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @updatedAt @db.Timestamptz(3)

  @@unique([monthKey, ipToken])
  @@index([monthKey])
  @@index([expiresAt])
}

model User {
  id          String    @id @default(uuid()) @db.Uuid
  name        String    @unique
  password    String
  role        Role      @default(PLAYER)
  createdDate DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt   DateTime? @updatedAt @db.Timestamptz(3)
  lastLogin   DateTime  @default(now()) @db.Timestamptz(3)

  gathers       UserGather[]
  ingredients   UserIngredients[]
  items         UserItems[]
  profile       UserProfile?
  ranking       Ranking?
  rewards       UserRewards[]
  statsTracking UserTracking[]
  wallets       UserWallet[]

  dinoz     Dinoz[]
  dinozShop UserDinozShop[]

  leader      Boolean @default(false)
  engineer    Boolean @default(false)
  cooker      Boolean @default(false)
  shopKeeper  Boolean @default(false)
  merchant    Boolean @default(false)
  priest      Boolean @default(false)
  teacher     Boolean @default(false)
  matelasseur Boolean @default(false)
  messie      Boolean @default(false)
}

model UserDinozShop {
  id      Int     @id @default(autoincrement())
  raceId  Int
  display String  @db.VarChar
  userId  String? @db.Uuid
  user    User?   @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@map("user_dinoz_shop")
}

model UserGather {
  id     Int     @id @default(autoincrement())
  place  Int
  type   Int
  grid   Int[]
  userId String? @db.Uuid
  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([userId])
  @@map("user_gather")
}

model UserIngredients {
  id           Int    @default(autoincrement())
  ingredientId Int
  quantity     Int
  userId       String @db.Uuid
  user         User   @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([ingredientId, userId])
  @@index([userId])
  @@map("user_ingredients")
}

model UserItems {
  id       Int    @default(autoincrement())
  itemId   Int
  quantity Int
  userId   String @db.Uuid
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([itemId, userId])
  @@index([userId])
  @@map("user_items")
}

model UserProfile {
  id     String @id @default(cuid())
  userId String @unique @db.Uuid
  user   User   @relation(fields: [userId], references: [id])

  avatar      Bytes?
  avatarType  String?
  language    Language? @default(FR)
  gender      Gender?
  age         Int?
  description String?
}

model UserRewards {
  id       Int     @id @default(autoincrement())
  rewardId Int
  userId   String? @db.Uuid
  user     User?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([rewardId, userId])
}

model UserTracking {
  id       Int    @id @default(autoincrement())
  stat     String
  quantity Int    @default(0)
  userId   String @db.Uuid
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([stat, userId])
  @@index([userId])
  @@index([stat])
  @@map("statsTracking")
}

model UserWallet {
  id     String    @id @default(uuid()) @db.Uuid
  type   MoneyType
  amount Int       @default(0)
  userId String    @db.Uuid
  user   User      @relation(fields: [userId], references: [id])

  @@unique([userId, type])
}

enum DinozState {
  frozen
  sacrificed
  selling
  superdom
  resting
  unfreezing
}

enum Language {
  FR
  EN
  ES
  DE
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum MoneyType {
  GOLD
  TREASURE_TICKET
}

enum Role {
  PLAYER
  MODERATOR
  ADMIN
  SUPER_ADMIN
}

enum JobType {
  DAILY_AT
  INTERVAL
}

enum JobStatus {
  IDLE
  RUNNING
  SUCCESS
  FAILED
}
